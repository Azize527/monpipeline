<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Suivi Commande</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 { font-size: 1.8em; font-weight: 600; }
        .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .controls {
            display: flex;
            gap: 15px;
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; transform: translateY(-1px); }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-secondary:hover { background: #1976D2; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .btn-small { padding: 4px 8px; font-size: 12px; }
        
        .filter-group { display: flex; gap: 10px; align-items: center; }
        select, input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        
        .sheet-container { padding: 30px; overflow-x: auto; }
        .table-wrapper { background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; }
        
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        
        th {
            background: #f1f3f4;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: #3c4043;
            border-right: 1px solid #dadce0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 8px 6px;
            border-right: 1px solid #dadce0;
            border-bottom: 1px solid #dadce0;
            font-size: 12px;
            vertical-align: middle;
        }
        
        .row-header {
            background: #f8f9fa !important;
            font-weight: 600;
            text-align: center;
            color: #5f6368;
            width: 40px;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        
        .delete-col {
            background: #fff5f5 !important;
            width: 30px;
            text-align: center;
            position: sticky;
            left: 40px;
            z-index: 5;
        }
        
        .col-narrow { width: 80px; }
        .col-medium { width: 100px; }
        .col-wide { width: 120px; }
        .col-contact { width: 140px; }
        
        .status {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
        }
        
        .status:hover { transform: scale(1.05); }
        .status-non-validee { background: #fff3e0; color: #f57c00; }
        .status-validee { background: #e3f2fd; color: #1976d2; }
        .status-planifiee { background: #f3e5f5; color: #7b1fa2; }
        .status-installee { background: #e8f5e8; color: #2e7d32; }
        .status-annulee { background: #ffebee; color: #c62828; }
        
        .priority-high { background: #ffebee; color: #c62828; }
        .priority-medium { background: #fff8e1; color: #ef6c00; }
        .priority-low { background: #f3e5f5; color: #8e24aa; }
        
        .progress-bar { width: 100px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #45a049); border-radius: 4px; transition: width 0.5s ease; }
        
        .editable {
            border: 1px solid transparent;
            padding: 8px;
            border-radius: 4px;
            cursor: text;
            min-width: 100px;
            background: transparent;
        }
        .editable:hover { background: #f5f5f5; border-color: #ddd; }
        .editable:focus { outline: none; background: white; border-color: #4CAF50; box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2); }
        
        .alert { color: #d32f2f; font-weight: bold; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-number { font-size: 2em; font-weight: bold; color: #4CAF50; }
        .stat-label { color: #666; margin-top: 8px; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 10px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal h3 { margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-group textarea { resize: vertical; }
        
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .close:hover { color: #000; }
        
        .client-list { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; margin-top: 20px; }
        .client-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .client-item:last-child { border-bottom: none; }
        .client-info { flex: 1; }
        .client-name { font-weight: 600; color: #333; }
        .client-details { font-size: 12px; color: #666; margin-top: 5px; }
        .client-actions { display: flex; gap: 5px; }
        
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s ease; }
        .tab.active { border-bottom-color: #4CAF50; color: #4CAF50; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        @media (max-width: 1200px) {
            .container { margin: 10px; }
            .controls { flex-direction: column; align-items: stretch; gap: 10px; }
            .filter-group { justify-content: space-between; }
            .form-row { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .sheet-container { padding: 15px; }
            .stats { grid-template-columns: 1fr; padding: 20px; }
            .header-buttons { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Pipeline Suivi Commande ‚Üí Installation</h1>
            <div class="header-buttons">
                <button class="btn btn-primary" onclick="addNewOrder()">‚ûï Nouvelle Commande</button>
                <button class="btn btn-primary" onclick="addNewClient()">üë§ Nouveau Client</button>
                <button class="btn btn-info" onclick="openClientManager()">üë• Gestion Clients</button>
                <button class="btn btn-warning" onclick="openSettings()">‚öôÔ∏è Param√®tres</button>
                <button class="btn btn-secondary" onclick="saveData()">üíæ Sauvegarder</button>
                <button class="btn btn-secondary" onclick="loadData()">üìÇ Charger</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalOrders">4</div>
                <div class="stat-label">Total Commandes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingOrders">3</div>
                <div class="stat-label">En Cours</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="installedOrders">1</div>
                <div class="stat-label">Install√©es</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgDelay">7j</div>
                <div class="stat-label">D√©lai Moyen</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalClients">4</div>
                <div class="stat-label">Clients</div>
            </div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <label>Filtrer par statut:</label>
                <select id="statusFilter" onchange="filterOrders()">
                    <option value="">Tous</option>
                    <option value="NON_VALIDEE">Non Valid√©e</option>
                    <option value="VALIDEE">Valid√©e</option>
                    <option value="PLANIFIEE">Installation Planifi√©e</option>
                    <option value="INSTALLEE">Install√©e</option>
                    <option value="ANNULEE">Annul√©e</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Filtrer par client:</label>
                <select id="clientFilter" onchange="filterOrders()">
                    <option value="">Tous les clients</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Rechercher:</label>
                <input type="text" id="searchInput" placeholder="Client, N¬∞ commande, produit..." oninput="filterOrders()">
            </div>
            <button class="btn btn-secondary" onclick="exportData()">üìä Exporter CSV</button>
            <button class="btn btn-secondary" onclick="sendNotifications()">üìß Notifier Clients</button>
        </div>

        <div class="sheet-container">
            <div class="table-wrapper">
                <table id="ordersTable">
                    <thead>
                        <tr>
                            <th class="row-header">#</th>
                            <th class="delete-col">üóëÔ∏è</th>
                            <th class="col-narrow">N¬∞ Commande</th>
                            <th class="col-medium">Client</th>
                            <th class="col-contact">Contact</th>
                            <th class="col-wide">Produit</th>
                            <th class="col-narrow">Montant HT</th>
                            <th class="col-narrow">Financement</th>
                            <th class="col-narrow">Statut</th>
                            <th class="col-narrow">Priorit√©</th>
                            <th class="col-narrow">Date Cmd</th>
                            <th class="col-narrow">Livraison</th>
                            <th class="col-narrow">Installation</th>
                            <th class="col-narrow">Technicien</th>
                            <th class="col-narrow">Progress</th>
                            <th class="col-wide">Commentaires</th>
                            <th class="col-narrow">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Nouvelle Commande -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('orderModal')">&times;</span>
            <h3>üìã Nouvelle Commande</h3>
            <form id="orderForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>N¬∞ Commande *</label>
                        <input type="text" id="orderNumber" required placeholder="Ex: CMD-001, 2025-001, etc.">
                    </div>
                    <div class="form-group">
                        <label>Client *</label>
                        <select id="clientSelect" required>
                            <option value="">S√©lectionner un client</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Produit *</label>
                        <input type="text" id="productName" required placeholder="Ex: Climatisation Daikin">
                    </div>
                    <div class="form-group">
                        <label>Montant HT (‚Ç¨)</label>
                        <input type="number" id="amountHT" step="0.01" placeholder="Ex: 2500.00">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Mode de Financement</label>
                        <select id="financing">
                            <option value="">S√©lectionner</option>
                            <option value="CASH">Comptant</option>
                            <option value="CREDIT">Cr√©dit</option>
                            <option value="LEASING">Leasing</option>
                            <option value="SUBVENTION">Subvention</option>
                            <option value="ECHELONNE">Paiement √©chelonn√©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Priorit√©</label>
                        <select id="priority">
                            <option value="NORMALE">Normale</option>
                            <option value="HAUTE">Haute</option>
                            <option value="BASSE">Basse</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Technicien</label>
                        <select id="technicianSelect">
                            <option value="">Non assign√©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date de Livraison Pr√©vue</label>
                        <input type="date" id="deliveryDate">
                    </div>
                </div>
                <div class="form-group">
                    <label>Commentaires</label>
                    <textarea id="comments" rows="3" placeholder="Informations suppl√©mentaires..."></textarea>
                </div>
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('orderModal')" style="margin-right: 10px;">Annuler</button>
                    <button type="submit" class="btn btn-primary">Cr√©er Commande</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gestion Clients -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('clientModal')">&times;</span>
            <h3>üë• Gestion des Clients</h3>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('clientList')">Liste des Clients</div>
                <div class="tab" onclick="switchTab('addClient')">Ajouter Client</div>
            </div>
            <div id="clientList" class="tab-content active">
                <div class="client-list" id="clientListContainer"></div>
            </div>
            <div id="addClient" class="tab-content">
                <form id="clientForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nom *</label>
                            <input type="text" id="clientName" required>
                        </div>
                        <div class="form-group">
                            <label>Pr√©nom</label>
                            <input type="text" id="clientFirstName">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="clientEmail">
                        </div>
                        <div class="form-group">
                            <label>T√©l√©phone</label>
                            <input type="tel" id="clientPhone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Adresse</label>
                        <textarea id="clientAddress" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="clientNotes" rows="2" placeholder="Informations suppl√©mentaires sur le client..."></textarea>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">Ajouter Client</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Param√®tres -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('settingsModal')">&times;</span>
            <h3>‚öôÔ∏è Param√®tres du Syst√®me</h3>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('technicianSettings')">Techniciens</div>
                <div class="tab" onclick="switchTab('generalSettings')">G√©n√©ral</div>
            </div>
            <div id="technicianSettings" class="tab-content active">
                <h4>Gestion des Techniciens</h4>
                <div class="form-group">
                    <label>Ajouter un technicien</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newTechnicianName" placeholder="Nom du technicien">
                        <button type="button" class="btn btn-primary" onclick="addTechnician()">Ajouter</button>
                    </div>
                </div>
                <div id="technicianList" style="margin-top: 20px;"></div>
            </div>
            <div id="generalSettings" class="tab-content">
                <h4>Param√®tres G√©n√©raux</h4>
                <div class="form-group">
                    <label>Nom de l'entreprise</label>
                    <input type="text" id="companyName" value="Votre Entreprise">
                </div>
                <div class="form-group">
                    <label>Email de notification</label>
                    <input type="email" id="notificationEmail" placeholder="admin@votre-entreprise.fr">
                </div>
                <div class="form-group">
                    <label>D√©lai d'alerte (jours)</label>
                    <input type="number" id="alertDelay" value="3" min="1">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Base de donn√©es
        let clients = [
            { id: 'CLI-001', name: 'Dupont', firstName: 'Martin', email: 'martin.dupont@email.fr', phone: '01 23 45 67 89', address: '123 Rue de la Paix, 75001 Paris', notes: 'Client fid√®le' },
            { id: 'CLI-002', name: 'Bernard', firstName: 'Sophie', email: 'sophie.bernard@email.fr', phone: '01 98 76 54 32', address: '456 Avenue des Champs, 69000 Lyon', notes: 'Pr√©f√®re les rendez-vous le matin' },
            { id: 'CLI-003', name: 'Morel', firstName: 'Jean', email: 'jean.morel@email.fr', phone: '01 11 22 33 44', address: '789 Boulevard du Centre, 33000 Bordeaux', notes: '' },
            { id: 'CLI-004', name: 'Dubois', firstName: 'Claire', email: 'claire.dubois@email.fr', phone: '01 55 66 77 88', address: '321 Rue Neuve, 31000 Toulouse', notes: 'Nouvelle cliente' }
        ];

        let technicians = ['Pierre L.', 'Marc T.', 'Julie M.', 'Antoine R.'];

        let orders = [
            { id: 'CMD-001', clientId: 'CLI-001', product: 'Climatisation Daikin', amountHT: 3500.00, financing: 'CREDIT', status: 'INSTALLEE', priority: 'HAUTE', orderDate: '2025-07-15', deliveryDate: '2025-07-20', installationDate: '2025-07-22', technician: 'Pierre L.', comments: 'Installation r√©ussie' },
            { id: 'CMD-002', clientId: 'CLI-002', product: 'Chaudi√®re Viessmann', amountHT: 5200.00, financing: 'SUBVENTION', status: 'PLANIFIEE', priority: 'NORMALE', orderDate: '2025-07-18', deliveryDate: '2025-07-24', installationDate: '2025-07-25', technician: 'Marc T.', comments: 'Installation pr√©vue demain' },
            { id: 'CMD-003', clientId: 'CLI-003', product: 'Pompe √† chaleur', amountHT: 8900.00, financing: 'CASH', status: 'VALIDEE', priority: 'BASSE', orderDate: '2025-07-20', deliveryDate: '2025-07-26', installationDate: '2025-07-28', technician: '', comments: 'Commande en cours de traitement' },
            { id: 'CMD-004', clientId: 'CLI-004', product: 'VMC Double Flux', amountHT: 1800.00, financing: 'ECHELONNE', status: 'NON_VALIDEE', priority: 'NORMALE', orderDate: '2025-07-23', deliveryDate: '2025-07-29', installationDate: '2025-07-30', technician: '', comments: 'En attente de validation' }
        ];

        let filteredOrders = [...orders];

        // Configurations
        var statuses = ['NON_VALIDEE', 'VALIDEE', 'PLANIFIEE', 'INSTALLEE', 'ANNULEE'];
        var statusMap = {
            'NON_VALIDEE': { text: 'NON VALID√âE', class: 'status-non-validee', progress: 10 },
            'VALIDEE': { text: 'VALID√âE', class: 'status-validee', progress: 30 },
            'PLANIFIEE': { text: 'INSTALLATION PLANIFI√âE', class: 'status-planifiee', progress: 70 },
            'INSTALLEE': { text: 'INSTALL√âE', class: 'status-installee', progress: 100 },
            'ANNULEE': { text: 'ANNUL√âE', class: 'status-annulee', progress: 0 }
        };

        var priorityMap = {
            'HAUTE': { text: 'HAUTE', class: 'priority-high' },
            'NORMALE': { text: 'NORMALE', class: 'priority-medium' },
            'BASSE': { text: 'BASSE', class: 'priority-low' }
        };

        var financingMap = {
            'CASH': { text: 'Comptant', class: 'status-installee' },
            'CREDIT': { text: 'Cr√©dit', class: 'status-validee' },
            'LEASING': { text: 'Leasing', class: 'status-planifiee' },
            'SUBVENTION': { text: 'Subvention', class: 'status-non-validee' },
            'ECHELONNE': { text: '√âchelonn√©', class: 'priority-medium' }
        };

        // Fonctions utilitaires
        function formatAmount(amount) {
            if (!amount) return '-';
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            var date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        function getClientById(clientId) {
            return clients.find(function(c) { return c.id === clientId; });
        }

        function getClientFullName(client) {
            return client ? client.firstName + ' ' + client.name : 'Client introuvable';
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            renderOrders();
            updateStats();
            populateClientSelects();
            populateTechnicianSelects();
            renderClientList();
            renderTechnicianList();
        });

        // Rendu des commandes
        function renderOrders() {
            var tbody = document.getElementById('ordersBody');
            tbody.innerHTML = '';

            filteredOrders.forEach(function(order, index) {
                var client = getClientById(order.clientId);
                var isLate = new Date(order.deliveryDate) < new Date() && order.status !== 'INSTALLEE' && order.status !== 'ANNULEE';
                
                var row = document.createElement('tr');
                row.innerHTML = 
                    '<td class="row-header">' + (index + 1) + '</td>' +
                    '<td class="delete-col"><button class="btn btn-warning btn-small" onclick="deleteOrder(\'' + order.id + '\')" title="Supprimer" style="padding: 2px 6px; font-size: 10px;">üóëÔ∏è</button></td>' +
                    '<td><strong style="font-size: 11px;">' + order.id + '</strong></td>' +
                    '<td style="font-size: 11px;">' + getClientFullName(client) + '</td>' +
                    '<td style="font-size: 10px;">' + (client ? 'üìß ' + client.email.split('@')[0] + '<br>üìû ' + client.phone.substring(0, 10) : 'N/A') + '</td>' +
                    '<td style="font-size: 11px;">' + order.product + '</td>' +
                    '<td class="editable" contenteditable="true" onblur="updateField(\'' + order.id + '\', \'amountHT\', this.textContent)" style="font-size: 11px; font-weight: bold; color: #2e7d32;">' + formatAmount(order.amountHT) + '</td>' +
                    '<td><span class="status ' + (financingMap[order.financing] ? financingMap[order.financing].class : 'status-validee') + '" style="font-size: 9px; padding: 3px 6px;">' + (financingMap[order.financing] ? financingMap[order.financing].text : 'N/A') + '</span></td>' +
                    '<td><select class="status ' + statusMap[order.status].class + '" onchange="updateStatus(\'' + order.id + '\', this.value)" style="font-size: 9px; padding: 2px 4px;">' + 
                        statuses.map(function(s) { return '<option value="' + s + '"' + (s === order.status ? ' selected' : '') + '>' + statusMap[s].text + '</option>'; }).join('') + 
                    '</select></td>' +
                    '<td><span class="status ' + priorityMap[order.priority].class + '" style="font-size: 9px; padding: 3px 6px;">' + priorityMap[order.priority].text + '</span></td>' +
                    '<td style="font-size: 10px;">' + formatDate(order.orderDate) + '</td>' +
                    '<td class="' + (isLate ? 'alert' : '') + '" style="font-size: 10px;">' + formatDate(order.deliveryDate) + (isLate ? ' üö®' : '') + '</td>' +
                    '<td class="editable" contenteditable="true" onblur="updateField(\'' + order.id + '\', \'installationDate\', this.textContent)" style="font-size: 10px;">' + formatDate(order.installationDate) + '</td>' +
                    '<td><select class="editable" onchange="updateField(\'' + order.id + '\', \'technician\', this.value)" style="font-size: 10px; padding: 2px;">' +
                        '<option value="">Non assign√©</option>' +
                        technicians.map(function(tech) { return '<option value="' + tech + '"' + (tech === order.technician ? ' selected' : '') + '>' + tech + '</option>'; }).join('') +
                    '</select></td>' +
                    '<td><div class="progress-bar" style="width: 60px; height: 6px;"><div class="progress-fill" style="width: ' + statusMap[order.status].progress + '%;"></div></div><small style="font-size: 9px;">' + statusMap[order.status].progress + '%</small></td>' +
                    '<td class="editable" contenteditable="true" onblur="updateField(\'' + order.id + '\', \'comments\', this.textContent)" style="font-size: 10px;">' + order.comments + '</td>' +
                    '<td><button class="btn btn-info btn-small" onclick="editOrder(\'' + order.id + '\')" title="Modifier" style="padding: 2px 4px; font-size: 10px;">‚úèÔ∏è</button><button class="btn btn-secondary btn-small" onclick="duplicateOrder(\'' + order.id + '\')" title="Dupliquer" style="padding: 2px 4px; font-size: 10px;">üìã</button></td>';
                
                tbody.appendChild(row);
            });
        }

        // Fonctions principales
        function addNewOrder() {
            document.getElementById('orderModal').style.display = 'block';
        }

        function addNewClient() {
            document.getElementById('clientModal').style.display = 'block';
            switchTab('addClient');
        }

        function openClientManager() {
            document.getElementById('clientModal').style.display = 'block';
            renderClientList();
        }

        function openSettings() {
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'orderModal') {
                document.getElementById('orderForm').reset();
                // Remettre le comportement normal du formulaire
                document.getElementById('orderForm').onsubmit = null;
            }
            if (modalId === 'clientModal') {
                document.getElementById('clientForm').reset();
                switchTab('clientList');
                // Remettre le comportement normal du formulaire
                document.getElementById('clientForm').onsubmit = null;
            }
        }

        // Mise √† jour des statistiques
        function updateStats() {
            var total = orders.length;
            var pending = orders.filter(function(o) { return o.status !== 'INSTALLEE' && o.status !== 'ANNULEE'; }).length;
            var installed = orders.filter(function(o) { return o.status === 'INSTALLEE'; }).length;
            var totalClients = clients.length;
            
            var completedOrders = orders.filter(function(o) { return o.status === 'INSTALLEE'; });
            var avgDelay = 0;
            if (completedOrders.length > 0) {
                var totalDays = completedOrders.reduce(function(sum, order) {
                    var orderDate = new Date(order.orderDate);
                    var installDate = new Date(order.installationDate);
                    return sum + Math.ceil((installDate - orderDate) / (1000 * 60 * 60 * 24));
                }, 0);
                avgDelay = Math.round(totalDays / completedOrders.length);
            }

            document.getElementById('totalOrders').textContent = total;
            document.getElementById('pendingOrders').textContent = pending;
            document.getElementById('installedOrders').textContent = installed;
            document.getElementById('avgDelay').textContent = avgDelay + 'j';
            document.getElementById('totalClients').textContent = totalClients;
        }

        // Filtrage
        function filterOrders() {
            var statusFilter = document.getElementById('statusFilter').value;
            var clientFilter = document.getElementById('clientFilter').value;
            var searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredOrders = orders.filter(function(order) {
                var client = getClientById(order.clientId);
                var clientName = getClientFullName(client).toLowerCase();
                
                var matchesStatus = !statusFilter || order.status === statusFilter;
                var matchesClient = !clientFilter || order.clientId === clientFilter;
                var matchesSearch = !searchTerm || 
                    clientName.includes(searchTerm) ||
                    order.id.toLowerCase().includes(searchTerm) ||
                    order.product.toLowerCase().includes(searchTerm) ||
                    order.technician.toLowerCase().includes(searchTerm);
                
                return matchesStatus && matchesClient && matchesSearch;
            });

            renderOrders();
        }

        // Gestion des onglets
        function switchTab(tabName) {
            var tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(function(tab) { tab.classList.remove('active'); });
            
            var tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(function(tab) { tab.classList.remove('active'); });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Mise √† jour du statut
        function updateStatus(orderId, newStatus) {
            var order = orders.find(function(o) { return o.id === orderId; });
            if (order) {
                order.status = newStatus;
                renderOrders();
                updateStats();
                
                var client = getClientById(order.clientId);
                showNotification('Statut mis √† jour: ' + getClientFullName(client) + ' - ' + statusMap[newStatus].text);
            }
        }

        // Mise √† jour d'un champ
        function updateField(orderId, field, value) {
            var order = orders.find(function(o) { return o.id === orderId; });
            if (order) {
                if (field === 'installationDate') {
                    order[field] = value.includes('/') ? convertDateFormat(value) : value;
                } else if (field === 'amountHT') {
                    var cleanValue = value.replace(/[^\d.,]/g, '').replace(',', '.');
                    order[field] = parseFloat(cleanValue) || 0;
                } else {
                    order[field] = value.trim ? value.trim() : value;
                }
                renderOrders();
                var client = getClientById(order.clientId);
                showNotification(field + ' mis √† jour pour ' + getClientFullName(client));
            }
        }

        // Actions sur les commandes
        function editOrder(orderId) {
            var order = orders.find(function(o) { return o.id === orderId; });
            if (order) {
                document.getElementById('orderNumber').value = order.id;
                document.getElementById('clientSelect').value = order.clientId;
                document.getElementById('productName').value = order.product;
                document.getElementById('amountHT').value = order.amountHT;
                document.getElementById('financing').value = order.financing;
                document.getElementById('priority').value = order.priority;
                document.getElementById('deliveryDate').value = order.deliveryDate;
                document.getElementById('installationDate').value = order.installationDate;
                document.getElementById('technicianSelect').value = order.technician;
                document.getElementById('comments').value = order.comments;
                
                var form = document.getElementById('orderForm');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    
                    var newOrderNumber = document.getElementById('orderNumber').value.trim();
                    
                    // V√©rifier si le nouveau num√©ro existe d√©j√† (sauf si c'est le m√™me)
                    if (newOrderNumber !== order.id) {
                        var existingOrder = orders.find(function(o) { return o.id === newOrderNumber; });
                        if (existingOrder) {
                            alert('Ce num√©ro de commande existe d√©j√†. Veuillez en choisir un autre.');
                            return;
                        }
                    }
                    
                    order.id = newOrderNumber;
                    order.clientId = document.getElementById('clientSelect').value;
                    order.product = document.getElementById('productName').value;
                    order.amountHT = parseFloat(document.getElementById('amountHT').value) || 0;
                    order.financing = document.getElementById('financing').value;
                    order.priority = document.getElementById('priority').value;
                    order.deliveryDate = document.getElementById('deliveryDate').value;
                    order.installationDate = document.getElementById('installationDate').value;
                    order.technician = document.getElementById('technicianSelect').value;
                    order.comments = document.getElementById('comments').value;
                    
                    renderOrders();
                    updateStats();
                    closeModal('orderModal');
                    form.onsubmit = null;
                    
                    var client = getClientById(order.clientId);
                    showNotification('Commande modifi√©e: ' + order.id + ' - ' + getClientFullName(client));
                };
                
                document.getElementById('orderModal').style.display = 'block';
            }
        }

        function duplicateOrder(orderId) {
            var order = orders.find(function(o) { return o.id === orderId; });
            if (order) {
                // Sugg√©rer un nouveau num√©ro bas√© sur l'original
                var suggestedNumber = order.id + '-COPY';
                var counter = 1;
                while (orders.find(function(o) { return o.id === suggestedNumber; })) {
                    suggestedNumber = order.id + '-COPY' + counter;
                    counter++;
                }
                
                var newOrderNumber = prompt('Num√©ro pour la commande dupliqu√©e:', suggestedNumber);
                if (!newOrderNumber) return; // Annul√©
                
                // V√©rifier si le num√©ro existe d√©j√†
                if (orders.find(function(o) { return o.id === newOrderNumber; })) {
                    alert('Ce num√©ro de commande existe d√©j√†.');
                    return;
                }
                
                var newOrder = {
                    id: newOrderNumber,
                    clientId: order.clientId,
                    product: order.product,
                    amountHT: order.amountHT,
                    financing: order.financing,
                    status: 'NON_VALIDEE',
                    priority: order.priority,
                    orderDate: new Date().toISOString().split('T')[0],
                    deliveryDate: order.deliveryDate,
                    installationDate: order.installationDate,
                    technician: order.technician,
                    comments: 'Duplicata de ' + order.id
                };
                
                orders.push(newOrder);
                filteredOrders = orders.slice();
                renderOrders();
                updateStats();
                showNotification('Commande dupliqu√©e: ' + newOrder.id);
            }
        }

        function deleteOrder(orderId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette commande ?')) {
                var orderIndex = orders.findIndex(function(o) { return o.id === orderId; });
                if (orderIndex !== -1) {
                    var deletedOrder = orders[orderIndex];
                    var client = getClientById(deletedOrder.clientId);
                    
                    orders.splice(orderIndex, 1);
                    filteredOrders = orders.slice();
                    renderOrders();
                    updateStats();
                    
                    showNotification('Commande supprim√©e: ' + deletedOrder.id + ' - ' + getClientFullName(client));
                }
            }
        }

        // Formulaires
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var orderNumber = document.getElementById('orderNumber').value.trim();
            var clientId = document.getElementById('clientSelect').value;
            var productName = document.getElementById('productName').value.trim();
            
            // Validation des champs obligatoires
            if (!orderNumber) {
                alert('Veuillez saisir un num√©ro de commande.');
                document.getElementById('orderNumber').focus();
                return;
            }
            
            if (!clientId) {
                alert('Veuillez s√©lectionner un client.');
                document.getElementById('clientSelect').focus();
                return;
            }
            
            if (!productName) {
                alert('Veuillez saisir un produit.');
                document.getElementById('productName').focus();
                return;
            }
            
            // V√©rifier si le num√©ro de commande existe d√©j√†
            var existingOrder = orders.find(function(o) { return o.id === orderNumber; });
            if (existingOrder) {
                alert('Ce num√©ro de commande existe d√©j√†. Veuillez en choisir un autre.');
                document.getElementById('orderNumber').focus();
                return;
            }
            
            var newOrder = {
                id: orderNumber,
                clientId: clientId,
                product: productName,
                amountHT: parseFloat(document.getElementById('amountHT').value) || 0,
                financing: document.getElementById('financing').value,
                status: 'NON_VALIDEE',
                priority: document.getElementById('priority').value,
                orderDate: new Date().toISOString().split('T')[0],
                deliveryDate: document.getElementById('deliveryDate').value,
                installationDate: document.getElementById('installationDate').value,
                technician: document.getElementById('technicianSelect').value,
                comments: document.getElementById('comments').value
            };

            orders.push(newOrder);
            filteredOrders = orders.slice();
            renderOrders();
            updateStats();
            closeModal('orderModal');
            
            var client = getClientById(newOrder.clientId);
            showNotification('Nouvelle commande cr√©√©e: ' + newOrder.id + ' - ' + getClientFullName(client));
        });

        document.getElementById('clientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var newClient = {
                id: 'CLI-' + String(clients.length + 1).padStart(3, '0'),
                name: document.getElementById('clientName').value,
                firstName: document.getElementById('clientFirstName').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                address: document.getElementById('clientAddress').value,
                notes: document.getElementById('clientNotes').value
            };

            clients.push(newClient);
            populateClientSelects();
            renderClientList();
            updateStats();
            document.getElementById('clientForm').reset();
            
            showNotification('Nouveau client ajout√©: ' + getClientFullName(newClient));
        });

        // Listes d√©roulantes
        function populateClientSelects() {
            var clientSelect = document.getElementById('clientSelect');
            var clientFilter = document.getElementById('clientFilter');
            
            [clientSelect, clientFilter].forEach(function(select) {
                if (select === clientFilter) {
                    select.innerHTML = '<option value="">Tous les clients</option>';
                } else {
                    select.innerHTML = '<option value="">S√©lectionner un client</option>';
                }
                
                clients.forEach(function(client) {
                    var option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = getClientFullName(client);
                    select.appendChild(option);
                });
            });
        }

        function populateTechnicianSelects() {
            var technicianSelect = document.getElementById('technicianSelect');
            technicianSelect.innerHTML = '<option value="">Non assign√©</option>';
            
            technicians.forEach(function(tech) {
                var option = document.createElement('option');
                option.value = tech;
                option.textContent = tech;
                technicianSelect.appendChild(option);
            });
        }

        function renderClientList() {
            var container = document.getElementById('clientListContainer');
            container.innerHTML = '';
            
            clients.forEach(function(client) {
                var clientDiv = document.createElement('div');
                clientDiv.className = 'client-item';
                clientDiv.innerHTML = 
                    '<div class="client-info">' +
                        '<div class="client-name">' + getClientFullName(client) + '</div>' +
                        '<div class="client-details">' +
                            'üìß ' + (client.email || 'N/A') + ' ‚Ä¢ üìû ' + (client.phone || 'N/A') + '<br>' +
                            'üìç ' + (client.address || 'Adresse non renseign√©e') +
                            (client.notes ? '<br>üìù ' + client.notes : '') +
                        '</div>' +
                    '</div>' +
                    '<div class="client-actions">' +
                        '<button class="btn btn-info btn-small" onclick="editClient(\'' + client.id + '\')" title="Modifier">‚úèÔ∏è</button>' +
                        '<button class="btn btn-warning btn-small" onclick="deleteClient(\'' + client.id + '\')" title="Supprimer">üóëÔ∏è</button>' +
                    '</div>';
                container.appendChild(clientDiv);
            });
        }

        function renderTechnicianList() {
            var container = document.getElementById('technicianList');
            container.innerHTML = '';
            
            technicians.forEach(function(tech) {
                var techDiv = document.createElement('div');
                techDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;';
                techDiv.innerHTML = 
                    '<span>' + tech + '</span>' +
                    '<button class="btn btn-warning btn-small" onclick="removeTechnician(\'' + tech + '\')">Supprimer</button>';
                container.appendChild(techDiv);
            });
        }

        // Gestion des techniciens
        function addTechnician() {
            var name = document.getElementById('newTechnicianName').value.trim();
            if (name && technicians.indexOf(name) === -1) {
                technicians.push(name);
                document.getElementById('newTechnicianName').value = '';
                populateTechnicianSelects();
                renderTechnicianList();
                showNotification('Technicien ajout√©: ' + name);
            }
        }

        function removeTechnician(name) {
            if (confirm('Supprimer le technicien ' + name + ' ?')) {
                technicians = technicians.filter(function(t) { return t !== name; });
                populateTechnicianSelects();
                renderTechnicianList();
                showNotification('Technicien supprim√©: ' + name);
            }
        }

        // Actions sur les clients
        function editClient(clientId) {
            var client = clients.find(function(c) { return c.id === clientId; });
            if (client) {
                document.getElementById('clientName').value = client.name;
                document.getElementById('clientFirstName').value = client.firstName;
                document.getElementById('clientEmail').value = client.email;
                document.getElementById('clientPhone').value = client.phone;
                document.getElementById('clientAddress').value = client.address;
                document.getElementById('clientNotes').value = client.notes;
                
                switchTab('addClient');
                
                var form = document.getElementById('clientForm');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    
                    client.name = document.getElementById('clientName').value;
                    client.firstName = document.getElementById('clientFirstName').value;
                    client.email = document.getElementById('clientEmail').value;
                    client.phone = document.getElementById('clientPhone').value;
                    client.address = document.getElementById('clientAddress').value;
                    client.notes = document.getElementById('clientNotes').value;
                    
                    populateClientSelects();
                    renderClientList();
                    renderOrders();
                    document.getElementById('clientForm').reset();
                    switchTab('clientList');
                    form.onsubmit = null;
                    
                    showNotification('Client modifi√©: ' + getClientFullName(client));
                };
            }
        }

        function deleteClient(clientId) {
            var hasOrders = orders.some(function(o) { return o.clientId === clientId; });
            
            if (hasOrders) {
                alert('Impossible de supprimer ce client car il a des commandes associ√©es.');
                return;
            }
            
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce client ?')) {
                clients = clients.filter(function(c) { return c.id !== clientId; });
                populateClientSelects();
                renderClientList();
                updateStats();
                showNotification('Client supprim√©');
            }
        }

        // Sauvegarde et chargement
        function saveData() {
            var data = {
                clients: clients,
                orders: orders,
                technicians: technicians,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            var jsonData = JSON.stringify(data, null, 2);
            var blob = new Blob([jsonData], { type: 'application/json' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'pipeline_sauvegarde_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            
            showNotification('Donn√©es sauvegard√©es avec succ√®s !');
        }

        function loadData() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                var file = e.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            var data = JSON.parse(event.target.result);
                            
                            if (data.clients && data.orders && data.technicians) {
                                if (confirm('√ätes-vous s√ªr de vouloir charger ces donn√©es ? Cela remplacera toutes les donn√©es actuelles.')) {
                                    clients = data.clients;
                                    orders = data.orders;
                                    technicians = data.technicians;
                                    filteredOrders = orders.slice();
                                    
                                    renderOrders();
                                    updateStats();
                                    populateClientSelects();
                                    populateTechnicianSelects();
                                    renderClientList();
                                    renderTechnicianList();
                                    
                                    showNotification('Donn√©es charg√©es avec succ√®s !');
                                }
                            } else {
                                alert('Fichier invalide. Veuillez s√©lectionner un fichier de sauvegarde valide.');
                            }
                        } catch (error) {
                            alert('Erreur lors du chargement du fichier. Veuillez v√©rifier le format.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Export CSV
        function exportData() {
            var headers = ['N¬∞ Commande', 'Client', 'Email', 'T√©l√©phone', 'Produit', 'Montant HT', 'Financement', 'Statut', 'Priorit√©', 'Date Commande', 'Date Livraison', 'Date Installation', 'Technicien', 'Commentaires'];
            var csvContent = [
                headers.join(','),
                orders.map(function(order) {
                    var client = getClientById(order.clientId);
                    return [
                        order.id,
                        '"' + getClientFullName(client) + '"',
                        '"' + (client && client.email ? client.email : '') + '"',
                        '"' + (client && client.phone ? client.phone : '') + '"',
                        '"' + order.product + '"',
                        order.amountHT,
                        '"' + (financingMap[order.financing] ? financingMap[order.financing].text : '') + '"',
                        statusMap[order.status].text,
                        priorityMap[order.priority].text,
                        order.orderDate,
                        order.deliveryDate,
                        order.installationDate,
                        '"' + order.technician + '"',
                        '"' + order.comments + '"'
                    ].join(',');
                }).join('\n')
            ].join('\n');

            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'commandes_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            
            showNotification('Export CSV t√©l√©charg√©');
        }

        function sendNotifications() {
            var pendingOrders = orders.filter(function(o) { return o.status !== 'INSTALLEE' && o.status !== 'ANNULEE'; });
            showNotification(pendingOrders.length + ' notifications envoy√©es aux clients');
        }

        function convertDateFormat(dateString) {
            var parts = dateString.split('/');
            if (parts.length === 3) {
                return parts[2] + '-' + parts[1].padStart(2, '0') + '-' + parts[0].padStart(2, '0');
            }
            return dateString;
        }

        function showNotification(message) {
            var notification = document.createElement('div');
            notification.style.cssText = 
                'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; ' +
                'padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); ' +
                'z-index: 2000; font-weight: 500; animation: slideIn 0.3s ease;';
            notification.textContent = message;
            
            var style = document.createElement('style');
            style.textContent = 
                '@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }';
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            setTimeout(function() {
                notification.remove();
                style.remove();
            }, 3000);
        }

        // Fermer modals
        window.onclick = function(event) {
            var modals = ['orderModal', 'clientModal', 'settingsModal'];
            modals.forEach(function(modalId) {
                var modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
        };
    </script>
</body>
</html>